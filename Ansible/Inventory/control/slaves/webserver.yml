-
    hosts: webserver
    become: yes
    tasks:
        -
            name: 'install web server application'
            apt: 'name{{item}} state=latest update_cache=yes'
            with_items: [apache2, wsgi, libapache2-mod-wsgi, apache2ctl, apachctl, 'python pip', python-virtualenv]
        -
            name: 'ensure apache_wsgi is running'
            apache2_module: 'name=wsgi state=present'
            notify: 'restart apache2'
        -
            name: 'copy demo application'
            copy: 'src=/home/demo/app/ dest=/var/www/demo mode=0755'
            notify: 'restart apache2'
        -
            name: 'copy apache virtual host config'
            copy: 'src=/home/demo/demo.conf dest=/etc/apache2/sites-available mode=0755'
        -
            name: 'Install virtualenv via pip'
            pip: {name: virtualenv, executable: pip3}
        -
            name: 'deactivate default apache sites'
            file: 'path=/etc/apache2/sites-enabled/000-default.conf state=absent'
            notify: 'restart apache2'
        -
            name: 'activate apache2 site'
            file: 'src=/etc/apache2/sites-available/demo.conf dest=/etc/apache2/sites-enabled/demo.conf state=link'
            notify: 'restart apache2'
        -
            name: 'setup python virtual env'
            pip: 'requirements=/var/www/demo/requirements.txt virtualenv=/var/www/demo/.venv'
            notify: 'restart apache2'
    handlers:
        -
            name: 'restart apache2'
            service: 'name=apache2 state=restarted'
